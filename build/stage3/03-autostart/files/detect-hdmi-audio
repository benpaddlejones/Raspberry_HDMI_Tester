#!/bin/bash
# Detect HDMI audio device dynamically
# Returns the correct ALSA device string for HDMI audio output
#
# NOTE: As of v1.0.0, /etc/asound.conf provides intelligent HDMI routing
# This script is kept for explicit device selection and logging purposes

# Function to find HDMI audio device
find_hdmi_audio() {
    # STRATEGY: Try multiple detection methods in order of reliability
    # PRIORITY: vc4-hdmi (DRM) over bcm2835 (legacy) for Pi 3B+/4/5 compatibility

    # Method 1a: Check for vc4-hdmi first (DRM/modern driver - Pi 3B+, Pi 4, Pi 5)
    local vc4_card
    vc4_card=$(aplay -l 2>/dev/null | grep -i "vc4-hdmi" | head -1 | grep -oP "card \K[0-9]+")

    if [ -n "${vc4_card}" ]; then
        # vc4-hdmi found - prefer plughw to keep format conversion in path
        local device="plughw:${vc4_card},0"
        echo "${device}"
        logger -t hdmi-audio-detect "Method 1a: Found vc4-hdmi (DRM): ${device}"
        return 0
    fi

    # Method 1b: Check for legacy bcm2835 HDMI (older Pi models without DRM)
    local bcm_card
    bcm_card=$(aplay -l 2>/dev/null | grep -i "bcm2835 HDMI" | head -1 | grep -oP "card \K[0-9]+")

    if [ -n "${bcm_card}" ]; then
        # Found legacy bcm2835 HDMI card
        local device="plughw:${bcm_card},0"
        echo "${device}"
        logger -t hdmi-audio-detect "Method 1b: Found bcm2835 HDMI (legacy): ${device}"
        return 0
    fi

    # Method 1c: Generic HDMI detection (fallback for any HDMI device)
    local hdmi_card
    hdmi_card=$(aplay -l 2>/dev/null | grep -i "hdmi" | head -1 | grep -oP "card \K[0-9]+")

    if [ -n "${hdmi_card}" ]; then
        # Found HDMI card via aplay listing
        local device="plughw:${hdmi_card},0"
        echo "${device}"
        logger -t hdmi-audio-detect "Method 1c: Found generic HDMI: ${device}"
        return 0
    fi

    # Method 2: Check /proc/asound/cards for HDMI identifiers
    # This works when aplay might not show friendly names
    local card_dir card_id card_num
    for card_dir in /proc/asound/card[0-9]*; do
        if [ -f "${card_dir}/id" ]; then
            card_id=$(cat "${card_dir}/id" 2>/dev/null)
            if echo "${card_id}" | grep -iqE "(hdmi|vc4)"; then
                card_num=$(basename "${card_dir}" | grep -oP "[0-9]+")
                if [ -n "${card_num}" ]; then
                    local device="plughw:${card_num},0"
                    echo "${device}"
                    logger -t hdmi-audio-detect "Method 2: Found HDMI via /proc/asound: ${device} (${card_id})"
                    return 0
                fi
            fi
        fi
    done

    # Method 3: Fallback to "default" PCM (uses /etc/asound.conf intelligent routing)
    # This leverages Debian's standard ALSA configuration which handles multi-model support
    echo "default"
    logger -t hdmi-audio-detect "Method 3: Using 'default' PCM (ALSA auto-routing via /etc/asound.conf)"
    return 0
}

# Main execution
HDMI_DEVICE=$(find_hdmi_audio)

# Output the device for scripts to use
echo "${HDMI_DEVICE}"

# Always succeeds - either explicit device or "default" with ALSA config routing
exit 0
