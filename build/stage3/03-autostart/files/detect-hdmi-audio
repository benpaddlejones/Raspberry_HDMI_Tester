#!/bin/bash
# Detect HDMI audio device dynamically
# Returns the correct ALSA device string for HDMI audio output
#
# NOTE: As of v1.0.0, /etc/asound.conf provides intelligent HDMI routing
# This script is kept for explicit device selection and logging purposes

pcm_alias_exists() {
    local pcm_name="$1"

    if [ -z "${pcm_name}" ]; then
        return 1
    fi

    if aplay -L 2>/dev/null | awk -F: 'NF{print $1}' | grep -Fxq "${pcm_name}"; then
        return 0
    fi

    # Fallback: parse /etc/asound.conf directly (covers early-boot before ALSA cache refresh)
    if [ -f /etc/asound.conf ] && \
        grep -Eq "^pcm[[:space:]]+${pcm_name}[[:space:]]*\\{" /etc/asound.conf; then
        return 0
    fi

    return 1
}

map_card_to_plug_alias() {
    local card="$1"

    case "${card}" in
        0) echo "hdmi0_plug" ;;
        1) echo "hdmi1_plug" ;;
        2) echo "hdmi2_plug" ;;
        3) echo "hdmi3_plug" ;;
        4) echo "hdmi4_plug" ;;
        5) echo "hdmi5_plug" ;;
        *) return 1 ;;
    esac

    return 0
}

resolve_device_for_card() {
    local card="$1"
    local driver_label="$2"

    local pcm_alias
    pcm_alias=$(map_card_to_plug_alias "${card}") || pcm_alias=""

    if [ -n "${pcm_alias}" ] && pcm_alias_exists "${pcm_alias}"; then
        logger -t hdmi-audio-detect "${driver_label}: using ${pcm_alias} (format-converting PCM)"
        echo "${pcm_alias}"
        return 0
    fi

    local convert_alias="${pcm_alias/_plug/_convert}"
    if [ -n "${convert_alias}" ] && [ "${convert_alias}" != "${pcm_alias}" ] && pcm_alias_exists "${convert_alias}"; then
        logger -t hdmi-audio-detect "${driver_label}: ${pcm_alias:-no PCM alias} unavailable; using ${convert_alias}"
        echo "${convert_alias}"
        return 0
    fi

    if pcm_alias_exists "hdmi_auto"; then
        logger -t hdmi-audio-detect "${driver_label}: falling back to hdmi_auto (global format-converting PCM)"
        echo "hdmi_auto"
        return 0
    fi

    local device="plughw:${card},0"
    logger -t hdmi-audio-detect "${driver_label}: ${pcm_alias:-no PCM alias}; falling back to ${device}"
    echo "${device}"
    return 0
}

# Function to find HDMI audio device
find_hdmi_audio() {
    # STRATEGY: Try multiple detection methods in order of reliability
    # PRIORITY: vc4-hdmi (DRM) over bcm2835 (legacy) for Pi 3B+/4/5 compatibility

    # Method 1a: Check for vc4-hdmi first (DRM/modern driver - Pi 3B+, Pi 4, Pi 5)
    local vc4_card
    vc4_card=$(aplay -l 2>/dev/null | grep -i "vc4-hdmi" | head -1 | grep -oP "card \K[0-9]+")

    if [ -n "${vc4_card}" ]; then
        resolve_device_for_card "${vc4_card}" "Method 1a: Found vc4-hdmi (DRM)"
        return 0
    fi

    # Method 1b: Check for legacy bcm2835 HDMI (older Pi models without DRM)
    local bcm_card
    bcm_card=$(aplay -l 2>/dev/null | grep -i "bcm2835 HDMI" | head -1 | grep -oP "card \K[0-9]+")

    if [ -n "${bcm_card}" ]; then
        resolve_device_for_card "${bcm_card}" "Method 1b: Found bcm2835 HDMI (legacy)"
        return 0
    fi

    # Method 1c: Generic HDMI detection (fallback for any HDMI device)
    local hdmi_card
    hdmi_card=$(aplay -l 2>/dev/null | grep -i "hdmi" | head -1 | grep -oP "card \K[0-9]+")

    if [ -n "${hdmi_card}" ]; then
        resolve_device_for_card "${hdmi_card}" "Method 1c: Found generic HDMI"
        return 0
    fi

    # Method 2: Check /proc/asound/cards for HDMI identifiers
    # This works when aplay might not show friendly names
    local card_dir card_id card_num
    for card_dir in /proc/asound/card[0-9]*; do
        if [ -f "${card_dir}/id" ]; then
            card_id=$(cat "${card_dir}/id" 2>/dev/null)
            if echo "${card_id}" | grep -iqE "(hdmi|vc4)"; then
                card_num=$(basename "${card_dir}" | grep -oP "[0-9]+")
                if [ -n "${card_num}" ]; then
                    resolve_device_for_card "${card_num}" "Method 2: Found HDMI via /proc/asound (${card_id})"
                    return 0
                fi
            fi
        fi
    done

    # Method 3: Fallback to "hdmi_auto" PCM (format-converting router)
    if pcm_alias_exists "hdmi_auto"; then
        logger -t hdmi-audio-detect "Method 3: Using hdmi_auto (ALSA auto-routing with format conversion)"
        echo "hdmi_auto"
        return 0
    fi

    # Method 4: Fallback to "default" PCM (whatever system provides)
    logger -t hdmi-audio-detect "Method 4: Fallback to 'default' PCM"
    echo "default"
    return 0
}

# Main execution
HDMI_DEVICE=$(find_hdmi_audio)

# Output the device for scripts to use
echo "${HDMI_DEVICE}"

# Always succeeds - either explicit device or "default" with ALSA config routing
exit 0
