#!/bin/bash
# Full Test: Combined image-test + color-test videos

# Source configuration library
source /usr/local/lib/hdmi-tester/config-lib.sh

LOG_DIR="/logs"
LOG_FILE="${LOG_DIR}/full-test.log"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Setup unbuffered logging (survives crashes)
exec > >(tee -a "${LOG_FILE}") 2>&1

# Trap handler to ensure logs are flushed on exit/error
cleanup() {
    local exit_code="$1"
    echo "=== Script terminated at $(date '+%Y-%m-%d %H:%M:%S') (exit code: ${exit_code}) ==="
    sync  # Flush filesystem buffers
}
trap 'cleanup "$?"' EXIT INT TERM

# Detect Raspberry Pi model and choose appropriate video format
# Pi 4 and higher: Use WebM (VP9 with hardware support)
# Pi 3 and lower: Use H.264 (hardware accelerated)
detect_video_format() {
    local model_info
    model_info=$(cat /proc/cpuinfo | grep "Model" | head -1)

    # Extract Pi version (look for "Raspberry Pi 4" or "Raspberry Pi 5", etc.)
    if echo "${model_info}" | grep -qE "Raspberry Pi [45678]"; then
        echo "webm"  # Pi 4+ has VP9 support
    else
        echo "mp4"   # Pi 3 and earlier: use H.264
    fi
}

VIDEO_FORMAT=$(detect_video_format)
IMAGE_VIDEO="/opt/hdmi-tester/image-test.${VIDEO_FORMAT}"
COLOR_VIDEO="/opt/hdmi-tester/color-test.${VIDEO_FORMAT}"
STEREO_FILE="/opt/hdmi-tester/stereo.flac"
SURROUND_FILE="/opt/hdmi-tester/surround51.flac"

# Use VLC auto-detect for video output
# VLC will automatically select the best available output

# Log startup info
echo "==========================================="
echo "Combined Test Loop (VLC) - Started $(date '+%Y-%m-%d %H:%M:%S')"
echo "==========================================="
echo "Video Format: ${VIDEO_FORMAT} (auto-detected)"
echo "Video Output: auto-detect (VLC will choose best available)"
echo "Files:"
echo "  - ${IMAGE_VIDEO}"
echo "  - ${COLOR_VIDEO}"
echo "Log: ${LOG_FILE}"
echo "PID: $$"
echo "User: $(whoami)"
echo "Working Directory: $(pwd)"
echo ""
echo "Sequence:"
echo "  1. Image test (optimized resolution)"
echo "  2. Color test (fullscreen stretched)"
echo "  3. Audio test - Stereo (2.0)"
echo "  4. Audio test - 5.1 Surround"
echo "  5. Loop forever"
echo ""
echo "Press Ctrl+C to stop"
echo ""

    # System information
    echo "=== System Information ==="
    echo "Hostname: $(hostname)"
    echo "Kernel: $(uname -r)"
    echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')"
    echo "Architecture: $(uname -m)"
    echo "CPU: $(cat /proc/cpuinfo | grep "Model" | head -1 | cut -d: -f2 | xargs)"
    echo "CPU Cores: $(nproc)"
    echo "Memory Total: $(free -h | awk '/^Mem:/ {print $2}')"
    echo "Memory Available: $(free -h | awk '/^Mem:/ {print $7}')"
    echo "GPU Memory: $(vcgencmd get_mem gpu 2>/dev/null || echo 'N/A')"
    echo "CPU Temperature: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
    echo ""

    # Check if video files exist
    echo "=== Video File Validation ==="
    if [ ! -f "${IMAGE_VIDEO}" ]; then
        echo "❌ ERROR: Image video not found at ${IMAGE_VIDEO}"
        exit 1
    fi
    echo "✓ Image video exists: $(ls -lh "${IMAGE_VIDEO}" | awk '{print $5}')"
    echo "  MD5: $(md5sum "${IMAGE_VIDEO}" | cut -d' ' -f1)"

    if [ ! -f "${COLOR_VIDEO}" ]; then
        echo "❌ ERROR: Color video not found at ${COLOR_VIDEO}"
        exit 1
    fi
    echo "✓ Color video exists: $(ls -lh "${COLOR_VIDEO}" | awk '{print $5}')"
    echo "  MD5: $(md5sum "${COLOR_VIDEO}" | cut -d' ' -f1)"
    echo ""

    # Check if audio files exist
    echo "=== Audio File Validation ==="
    if [ ! -f "${STEREO_FILE}" ]; then
        echo "❌ ERROR: Stereo audio file not found at ${STEREO_FILE}"
        exit 1
    fi
    echo "✓ Stereo FLAC exists: $(ls -lh "${STEREO_FILE}" | awk '{print $5}')"
    echo "  MD5: $(md5sum "${STEREO_FILE}" | cut -d' ' -f1)"

    if [ ! -f "${SURROUND_FILE}" ]; then
        echo "❌ ERROR: Surround audio file not found at ${SURROUND_FILE}"
        exit 1
    fi
    echo "✓ 5.1 Surround FLAC exists: $(ls -lh "${SURROUND_FILE}" | awk '{print $5}')"
    echo "  MD5: $(md5sum "${SURROUND_FILE}" | cut -d' ' -f1)"
    echo ""

    # Display and audio info
    echo "=== Display Information ==="
    tvservice -s 2>/dev/null || echo "tvservice not available"
    echo ""
    echo "=== Audio Devices ==="
    aplay -l 2>&1 | head -10 || echo "No ALSA devices"
    echo ""

    # VLC version
    echo "=== VLC Version ==="
    cvlc --version 2>&1 | head -5
    echo ""

    # Loop counter
    LOOP_COUNT=0

    # VLC will auto-detect best video output
    # No need for model-specific flags
    VIDEO_FLAGS=""

    # Get debug flags from config
    VLC_FLAGS=$(get_vlc_flags)

    # Loop forever with Raspberry Pi optimized flags using VLC
    while true; do
        LOOP_COUNT=$((LOOP_COUNT + 1))
        echo "==========================================="
        echo "Loop Iteration: ${LOOP_COUNT}"
        echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "==========================================="

        # System status
        echo "CPU Temp: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
        echo "Load: $(cat /proc/loadavg | cut -d' ' -f1-3)"
        echo "Memory Free: $(free -h | awk '/^Mem:/ {print $7}')"
        echo ""

        echo "[${LOOP_COUNT}] Playing: image-test.${VIDEO_FORMAT} (optimized resolution with aspect ratio)..."
        echo "Start: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo "Command: cvlc ${VIDEO_FLAGS} --play-and-exit --no-video-title-show --aout=alsa ${VLC_FLAGS} ${IMAGE_VIDEO}"
        cvlc --play-and-exit --no-video-title-show \
            ${VIDEO_FLAGS} --aout=alsa \
            --audio-resampler=soxr --audio-filter=normvol \
            --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
            "${IMAGE_VIDEO}" 2>&1
        VLC_EXIT=$?
        echo "Exit code: ${VLC_EXIT}"
        echo "End: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo ""

        echo "[${LOOP_COUNT}] Playing: color-test.${VIDEO_FORMAT} (fullscreen stretched for pixel testing)..."
        echo "Start: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo "Command: cvlc ${VIDEO_FLAGS} --play-and-exit --fullscreen --no-video-title-show --aout=alsa ${VLC_FLAGS} ${COLOR_VIDEO}"
        cvlc --play-and-exit --fullscreen --no-autoscale \
            --no-video-title-show \
            ${VIDEO_FLAGS} --aout=alsa \
            --audio-resampler=soxr --audio-filter=normvol \
            --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
            "${COLOR_VIDEO}" 2>&1
        VLC_EXIT=$?
        echo "Exit code: ${VLC_EXIT}"
        echo "End: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo ""

        echo "[${LOOP_COUNT}] Playing: Stereo Audio Test (2.0)..."
        echo "Start: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo "Command: cvlc --play-and-exit --no-video --aout=alsa ${VLC_FLAGS} ${STEREO_FILE}"
        cvlc --play-and-exit --no-video --aout=alsa \
            --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
            "${STEREO_FILE}" 2>&1
        VLC_EXIT=$?
        echo "Exit code: ${VLC_EXIT}"
        echo "End: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo ""

        echo "[${LOOP_COUNT}] Playing: 5.1 Surround Audio Test..."
        echo "Start: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo "Command: cvlc --play-and-exit --no-video --aout=alsa ${VLC_FLAGS} ${SURROUND_FILE}"
        cvlc --play-and-exit --no-video --aout=alsa \
            --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
            "${SURROUND_FILE}" 2>&1
        VLC_EXIT=$?
        echo "Exit code: ${VLC_EXIT}"
        echo "End: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo ""

        echo "Restarting loop (iteration ${LOOP_COUNT} complete)..."
        echo ""
        sleep 1
    done
