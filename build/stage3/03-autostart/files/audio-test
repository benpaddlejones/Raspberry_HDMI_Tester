#!/bin/bash
# Audio Test Script: Loop stereo.flac and surround51.flac for HDMI audio testing

# Source configuration library
source /usr/local/lib/hdmi-tester/config-lib.sh

STEREO_FILE="/opt/hdmi-tester/stereo.flac"
SURROUND_FILE="/opt/hdmi-tester/surround51.flac"
LOG_DIR="/logs"
LOG_FILE="${LOG_DIR}/audio-test.log"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Log rotation: Keep only 10 most recent logs
rotate_logs() {
    local base_log="$1"
    local max_logs=10

    # If current log exists and is larger than 5MB, rotate it
    if [ -f "${base_log}" ]; then
        local size
        size=$(stat -f%z "${base_log}" 2>/dev/null || stat -c%s "${base_log}" 2>/dev/null || echo 0)
        if [ "${size}" -gt 5242880 ]; then  # 5MB
            local timestamp
            timestamp=$(date '+%Y%m%d_%H%M%S')
            mv "${base_log}" "${base_log}.${timestamp}"
        fi
    fi

    # Remove old rotated logs, keep only most recent 10
    ls -t "${base_log}".* 2>/dev/null | tail -n +$((max_logs + 1)) | xargs -r rm -f
}

rotate_logs "${LOG_FILE}"

# Setup unbuffered logging (survives crashes)
exec > >(tee -a "${LOG_FILE}") 2>&1

# Trap handler to ensure logs are flushed on exit/error
cleanup() {
    local exit_code="$1"
    echo "=== Script terminated at $(date '+%Y-%m-%d %H:%M:%S') (exit code: ${exit_code}) ==="
    # Kill VLC if it's still running
    if [ -n "${VLC_PID}" ] && kill -0 "${VLC_PID}" 2>/dev/null; then
        kill -TERM "${VLC_PID}" 2>/dev/null
    fi
    sync  # Flush filesystem buffers
}
trap 'cleanup "$?"' EXIT INT TERM

# Cache debug flag once to avoid repeated config reads
if is_debug_enabled; then
    DEBUG_ENABLED=true
else
    DEBUG_ENABLED=false
fi

# Log startup info
echo "==========================================="
echo "Audio Test Loop (VLC) - Started $(date '+%Y-%m-%d %H:%M:%S')"
echo "==========================================="
echo "Files:"
echo "  - ${STEREO_FILE}"
echo "  - ${SURROUND_FILE}"
echo "Log: ${LOG_FILE}"
echo "PID: $$"
echo "User: $(whoami)"
echo "Working Directory: $(pwd)"
echo ""

    if [ "${DEBUG_ENABLED}" = true ]; then
        # System information (debug)
        echo "=== System Information ==="
        echo "Hostname: $(hostname)"
        echo "Kernel: $(uname -r)"
        echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME | cut -d= -f2 | tr -d '"')"
        echo "Architecture: $(uname -m)"
        echo "CPU: $(cat /proc/cpuinfo | grep "Model" | head -1 | cut -d: -f2 | xargs)"
        echo "CPU Cores: $(nproc)"
        echo "Memory Total: $(free -h | awk '/^Mem:/ {print $2}')"
        echo "Memory Available: $(free -h | awk '/^Mem:/ {print $7}')"
        echo "GPU Memory: $(vcgencmd get_mem gpu 2>/dev/null || echo 'N/A')"
        echo "CPU Temperature: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
        echo "CPU Frequency: $(vcgencmd measure_clock arm 2>/dev/null || echo 'N/A')"
        echo "Uptime: $(uptime -p)"
        echo ""

        # Boot configuration (debug)
        echo "=== Boot Configuration ==="
        if [ -f /boot/firmware/config.txt ]; then
            echo "HDMI Config:"
            grep -E "^hdmi_|^gpu_mem" /boot/firmware/config.txt 2>/dev/null || echo "No HDMI config found"
        elif [ -f /boot/config.txt ]; then
            echo "HDMI Config:"
            grep -E "^hdmi_|^gpu_mem" /boot/config.txt 2>/dev/null || echo "No HDMI config found"
        fi
        echo ""
    fi

    # Audio devices
    echo "=== Audio Devices ==="
    if [ -f /etc/asound.conf ]; then
        echo "Audio Output: Custom /etc/asound.conf detected (check configuration)"
    else
        echo "Audio Output: HDMI (default ALSA device)"
    fi
    if [ "${DEBUG_ENABLED}" = true ]; then
        echo ""
        echo "ALSA Devices (Debug):"
        aplay -l 2>&1 || echo "No ALSA devices found"
        echo ""
        echo "ALSA PCM Devices (Debug):"
        aplay -L 2>&1 | head -20 || echo "No ALSA PCM devices found"
        echo ""
        echo "Audio Sinks (Debug):"
        pactl list sinks short 2>&1 || echo "PulseAudio not available"
        echo ""
    else
        if aplay -l >/dev/null 2>&1; then
            echo "✓ ALSA playback device detected"
        else
            echo "❌ No ALSA playback devices detected"
        fi
        if pactl list sinks short >/dev/null 2>&1; then
            echo "✓ PulseAudio available"
        else
            echo "ℹ️ PulseAudio not available (expected on Lite builds)"
        fi
        echo ""
    fi

    # Check audio files
    echo "=== Audio File Check ==="
    if [ ! -f "${STEREO_FILE}" ]; then
        echo "❌ ERROR: Stereo audio file not found at ${STEREO_FILE}"
        exit 1
    fi
    echo "✓ Stereo FLAC verified"
    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "  Path: ${STEREO_FILE}"
        echo "  Size: $(ls -lh "${STEREO_FILE}" | awk '{print $5}')"
        echo "  Details:"
        file "${STEREO_FILE}" 2>&1 | sed 's/^/    /'
        echo "  MD5: $(md5sum "${STEREO_FILE}" | cut -d' ' -f1)"
        echo ""
    else
        echo ""
    fi

    if [ ! -f "${SURROUND_FILE}" ]; then
        echo "❌ ERROR: Surround audio file not found at ${SURROUND_FILE}"
        exit 1
    fi
    echo "✓ 5.1 Surround FLAC verified"
    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "  Path: ${SURROUND_FILE}"
        echo "  Size: $(ls -lh "${SURROUND_FILE}" | awk '{print $5}')"
        echo "  Details:"
        file "${SURROUND_FILE}" 2>&1 | sed 's/^/    /'
        echo "  MD5: $(md5sum "${SURROUND_FILE}" | cut -d' ' -f1)"
        echo ""
    else
        echo ""
    fi

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "Audio Metadata (ffprobe):"
        if command -v ffprobe &> /dev/null; then
            echo "Stereo FLAC:"
            ffprobe -v quiet -show_format -show_streams "${STEREO_FILE}" 2>&1 | head -30 | sed 's/^/  /'
            echo ""
            echo "5.1 Surround FLAC:"
            ffprobe -v quiet -show_format -show_streams "${SURROUND_FILE}" 2>&1 | head -30 | sed 's/^/  /'
        else
            echo "ffprobe not available"
        fi
        echo ""
    fi

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "=== Environment Variables ==="
        echo "DISPLAY=${DISPLAY:-not set}"
        echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-not set}"
        echo "TERM=${TERM:-not set}"
        echo "PATH=${PATH}"
        echo ""

        echo "=== VLC Version and Capabilities ==="
        cvlc --version 2>&1
        echo ""
        echo "VLC Audio Outputs:"
        cvlc --list | grep -A 50 "aout" 2>&1 | head -60
        echo ""
    fi

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "=== System Resources (Before Start) ==="
        echo "Load Average: $(cat /proc/loadavg)"
        echo "Memory:"
        free -h
        echo ""
        echo "Disk Space:"
        df -h / /boot 2>/dev/null
        echo ""

        echo "=== Process Information ==="
        echo "Running audio processes:"
        ps aux | grep -E "vlc|aplay|paplay" | grep -v grep || echo "None"
        echo ""
    fi

    echo "=== Starting VLC Audio Loop (Verbose Mode) ==="
    echo "Start Time: $(date '+%Y-%m-%d %H:%M:%S.%N')"
    echo ""

    # Get debug flags from config
    VLC_FLAGS=$(get_vlc_flags)

    # Loop forever, playing stereo then surround
    while true; do
        # --- Play Stereo Test ---
        echo "--- Playing Stereo Test ---"
        if [ "${DEBUG_ENABLED}" = true ]; then
            echo "Command: cvlc --play-and-exit --no-video --aout=alsa ${VLC_FLAGS} ${STEREO_FILE}"
        fi
        cvlc --play-and-exit --no-video --aout=alsa \
            --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
            "${STEREO_FILE}" 2>&1
        echo "--- Stereo test finished ---"
        echo ""
        sleep 2

        # --- Play 5.1 Surround Test ---
        echo "--- Playing 5.1 Surround Test ---"
        if [ "${DEBUG_ENABLED}" = true ]; then
            echo "Command: cvlc --play-and-exit --no-video --aout=alsa ${VLC_FLAGS} ${SURROUND_FILE}"
        fi
        cvlc --play-and-exit --no-video --aout=alsa \
            --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
            "${SURROUND_FILE}" 2>&1
        echo "--- 5.1 Surround test finished ---"
        echo ""
        sleep 2
    done

