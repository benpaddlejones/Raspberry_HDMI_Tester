#!/bin/bash
# Detect HDMI audio device dynamically
# Returns the correct ALSA device string for HDMI audio output

# Function to find HDMI audio device
find_hdmi_audio() {
    # Try multiple methods to find HDMI audio device
    
    # Method 1: Look for vc4hdmi or hdmi in card name
    local hdmi_card=$(aplay -l 2>/dev/null | grep -iE "(vc4-hdmi|hdmi)" | head -1 | grep -oP "card \K[0-9]+")
    
    if [ -n "${hdmi_card}" ]; then
        echo "hw:${hdmi_card},0"
        return 0
    fi
    
    # Method 2: Check proc/asound for HDMI cards
    for card in /proc/asound/card*; do
        if [ -f "${card}/id" ]; then
            card_id=$(cat "${card}/id")
            if echo "${card_id}" | grep -iqE "(hdmi|vc4)"; then
                card_num=$(basename "${card}" | grep -oP "\d+")
                echo "hw:${card_num},0"
                return 0
            fi
        fi
    done
    
    # Method 3: Try default HDMI device names
    for device in "hw:vc4hdmi,0" "hw:HDMI,0" "hw:b1,0" "hw:2,0" "hw:1,0"; do
        if aplay -D "${device}" /dev/zero -f S16_LE -d 0 -q 2>/dev/null & 
        then
            local pid=$!
            sleep 0.1
            kill -9 ${pid} 2>/dev/null
            wait ${pid} 2>/dev/null
            echo "${device}"
            return 0
        fi
    done
    
    # Fallback: use default
    echo "default"
    return 1
}

# Main execution
HDMI_DEVICE=$(find_hdmi_audio)
echo "${HDMI_DEVICE}"

# Optional: Log the detection for debugging
logger -t hdmi-audio-detect "Detected HDMI audio device: ${HDMI_DEVICE}"
