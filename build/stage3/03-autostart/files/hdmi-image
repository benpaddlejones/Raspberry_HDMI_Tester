#!/bin/bash
# HDMI Image Display Script
# Displays test pattern on framebuffer until manually stopped

set -e

IMAGE_FILE="/opt/hdmi-tester/image.png"

echo "========================================="
echo "HDMI Image Display Test"
echo "========================================="
echo "Timestamp: $(date)"
echo ""

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "‚ö†Ô∏è  WARNING: Not running as root. You may need sudo for framebuffer access."
    echo "   Try: sudo hdmi-image"
    echo ""
fi

# Check if image file exists
echo "üìÅ Checking test pattern file..."
if [ ! -f "${IMAGE_FILE}" ]; then
    echo "‚ùå ERROR: Test pattern not found at ${IMAGE_FILE}"
    exit 1
fi
echo "‚úì Test pattern exists: $(stat -c%s ${IMAGE_FILE}) bytes"
file "${IMAGE_FILE}"
echo ""

# Check framebuffer device
echo "üñ•Ô∏è  Checking framebuffer device..."
if [ ! -c /dev/fb0 ]; then
    echo "‚ùå ERROR: Framebuffer device /dev/fb0 not found"
    echo ""
    echo "Available devices:"
    ls -la /dev/fb* 2>&1 || echo "No framebuffer devices found"
    exit 1
fi
echo "‚úì Framebuffer /dev/fb0 exists"
echo ""

# Check fbi command
echo "üîß Checking fbi command..."
if ! command -v fbi >/dev/null 2>&1; then
    echo "‚ùå ERROR: fbi command not found"
    echo "   Install with: sudo apt-get install fbi"
    exit 1
fi
echo "‚úì fbi found at: $(which fbi)"
echo ""

# Display framebuffer info
echo "üì∫ Framebuffer information:"
fbset -s 2>&1 || echo "‚ö†Ô∏è  WARNING: Could not read framebuffer settings"
echo ""

# Launch fbi
echo "üöÄ Launching image display..."
echo "   Image: ${IMAGE_FILE}"
echo "   Device: /dev/fb0"
echo "   Press Ctrl+C to stop"
echo ""
echo "========================================="
echo ""

# Run fbi with:
# -T 1 = Use framebuffer device 1 (fb0)
# -a = Auto-zoom to fit screen
# -d = Don't wait after displaying
# --noverbose = Suppress verbose output
exec fbi -T 1 -a -d --noverbose "${IMAGE_FILE}"
