#!/bin/bash
# Generate ALSA configuration to route audio to ALL detected audio cards
# This creates a "multi" plugin that duplicates audio to every available output

set -e

OUTPUT_FILE="/run/asound-multi.conf"
TEMP_FILE="${OUTPUT_FILE}.tmp"

# Get list of all audio cards
CARDS=()
while IFS= read -r line; do
    if [[ $line =~ ^card\ ([0-9]+): ]]; then
        CARDS+=("${BASH_REMATCH[1]}")
    fi
done < <(aplay -l 2>/dev/null)

# If no cards found, create a minimal config
if [ ${#CARDS[@]} -eq 0 ]; then
    echo "# No audio cards detected" > "${OUTPUT_FILE}"
    logger -t alsa-multi "No audio cards detected, creating empty config"
    exit 0
fi

logger -t alsa-multi "Detected ${#CARDS[@]} audio card(s): ${CARDS[*]}"

# Start building the configuration
cat > "${TEMP_FILE}" << 'EOF'
# Auto-generated ALSA configuration for multi-card output
# Generated by generate-multi-card-asound
# DO NOT EDIT - This file is regenerated on every boot

EOF

# Define individual card outputs as PCM slaves
echo "# Define PCM devices for each detected card" >> "${TEMP_FILE}"
for card in "${CARDS[@]}"; do
    cat >> "${TEMP_FILE}" << EOF
pcm.card${card}_output {
    type hw
    card ${card}
    device 0
}

EOF
done

# If only one card, just make it the default (no multi needed)
if [ ${#CARDS[@]} -eq 1 ]; then
    cat >> "${TEMP_FILE}" << EOF
# Only one card detected, using it directly with plug for format conversion
pcm.!default {
    type plug
    slave.pcm "card${CARDS[0]}_output"
}

ctl.!default {
    type hw
    card ${CARDS[0]}
}
EOF
    mv "${TEMP_FILE}" "${OUTPUT_FILE}"
    logger -t alsa-multi "Single card config created for card ${CARDS[0]}"
    exit 0
fi

# Multiple cards: create multi plugin
echo "# Create multi plugin to duplicate audio to all cards" >> "${TEMP_FILE}"
cat >> "${TEMP_FILE}" << 'EOF'
pcm.multi_output {
    type multi
    slaves {
EOF

# Add each card as a slave (a, b, c, ...)
slave_letters=()
for i in "${!CARDS[@]}"; do
    letter=$(printf "\\$(printf '%03o' $((97 + i)))")  # a=97, b=98, c=99...
    slave_letters+=("$letter")
    echo "        ${letter} { pcm \"card${CARDS[$i]}_output\" channels 2 }" >> "${TEMP_FILE}"
done

cat >> "${TEMP_FILE}" << 'EOF'
    }
    bindings {
EOF

# Create bindings: map stereo input to all outputs
output_channel=0
for i in "${!CARDS[@]}"; do
    letter="${slave_letters[$i]}"
    # Left channel
    echo "        ${output_channel} { slave ${letter} channel 0 }" >> "${TEMP_FILE}"
    ((output_channel++))
    # Right channel
    echo "        ${output_channel} { slave ${letter} channel 1 }" >> "${TEMP_FILE}"
    ((output_channel++))
done

cat >> "${TEMP_FILE}" << 'EOF'
    }
}

EOF

# Create route plugin to duplicate stereo input to all outputs
total_channels=$((${#CARDS[@]} * 2))
cat >> "${TEMP_FILE}" << EOF
# Route stereo input to all ${#CARDS[@]} card(s) (${total_channels} total channels)
pcm.multi_route {
    type route
    slave.pcm "multi_output"
    slave.channels ${total_channels}
    ttable {
EOF

# Create routing table: duplicate L/R to all cards
output_channel=0
for i in "${!CARDS[@]}"; do
    # Left channel input (0) -> this card's left output
    echo "        0.${output_channel} 1" >> "${TEMP_FILE}"
    ((output_channel++))
    # Right channel input (1) -> this card's right output
    echo "        1.${output_channel} 1" >> "${TEMP_FILE}"
    ((output_channel++))
done

cat >> "${TEMP_FILE}" << 'EOF'
    }
}

# Final default device with format conversion
pcm.!default {
    type plug
    slave.pcm "multi_route"
}

ctl.!default {
    type hw
    card 0
}
EOF

# Atomically move into place
mv "${TEMP_FILE}" "${OUTPUT_FILE}"
chmod 644 "${OUTPUT_FILE}"

logger -t alsa-multi "Multi-card config created for ${#CARDS[@]} cards: ${CARDS[*]}"
echo "Multi-card ALSA config generated: ${#CARDS[@]} cards detected"
