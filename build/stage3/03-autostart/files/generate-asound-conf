#!/bin/bash
set -e

# This script detects the correct HDMI audio device and generates
# a dynamic /etc/asound.conf to route all audio to it.

LOG_FILE="/var/log/hdmi-audio-config.log"
exec > >(tee -a "${LOG_FILE}") 2>&1

echo "Starting Dynamic ALSA Configuration..."
echo "Timestamp: $(date)"

# Find the first available HDMI audio card
# It could be 'vc4-hdmi', 'vc4-hdmi0', 'vc4-hdmi1', or legacy 'HDMI'
HDMI_CARD=$(aplay -l | grep -E 'card.*(vc4-hdmi|HDMI)' | head -n 1 | awk -F' ' '{print $2}' | sed 's/://')

if [ -z "${HDMI_CARD}" ]; then
    echo "ERROR: No HDMI audio card found. ALSA configuration not created."
    exit 1
fi

echo "Detected HDMI Audio Card: ${HDMI_CARD}"

# Create the dynamic asound.conf
cat > /etc/asound.conf << EOF
# Auto-generated by generate-asound-conf on $(date)
# Do not edit.

# This PCM definition creates a 'plug' layer for automatic format,
# rate, and channel conversion, which then sends audio to a 'dmix'
# plugin for software mixing. The dmix slave is dynamically set
# to the detected HDMI card.

pcm.hdmi_auto {
    type plug
    slave.pcm "hdmi_dmix"
    hint {
        show on
        description "Auto-detected HDMI Audio Output with Format Conversion"
    }
}

pcm.hdmi_dmix {
    type dmix
    ipc_key 5678293
    ipc_perm 0660
    ipc_gid audio
    slave {
        pcm {
            type hw
            card ${HDMI_CARD}
            device 0
        }
        period_time 0
        period_size 1024
        buffer_size 4096
    }
}

# Set our dynamic HDMI device as the system-wide default
pcm.!default {
    type asym
    playback.pcm "hdmi_auto"
    capture.pcm {
        type null
    }
}

# Default control device
ctl.!default {
    type hw
    card ${HDMI_CARD}
}
EOF

chmod 644 /etc/asound.conf
echo "Successfully created /etc/asound.conf for card ${HDMI_CARD}"
echo "Configuration complete."
