name: Build LibreELEC Image with HDMI Tester

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        id: config
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            VERSION="${GITHUB_REF_NAME#v}"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Building LibreELEC image v$VERSION"

      - name: Install dependencies
        run: |
          echo "üì• Installing build tools..."
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            xz-utils \
            parted \
            kpartx \
            e2fsprogs \
            dosfstools \
            python3 \
            python3-pil \
            ffmpeg \
            zip \
            rsync \
            pigz

      - name: Download LibreELEC base image
        run: |
          echo "üì• Downloading LibreELEC 12.x (Kodi 21 Omega)..."
          mkdir -p build/libreelec
          cd build/libreelec

          # Download LibreELEC for Raspberry Pi 4/5 (ARM 64-bit)
          LIBREELEC_VERSION="12.0.1"
          LIBREELEC_URL="https://releases.libreelec.tv/LibreELEC-RPi4.arm-${LIBREELEC_VERSION}.img.gz"

          wget -O LibreELEC-base.img.gz "${LIBREELEC_URL}"
          gunzip LibreELEC-base.img.gz

          echo "‚úÖ LibreELEC base image downloaded"
          ls -lh LibreELEC-base.img

      - name: Expand image size
        run: |
          echo "üìè Expanding image to accommodate addon and media..."
          cd build/libreelec

          # Add 2GB to the image for addon + media assets
          truncate -s +2G LibreELEC-base.img

          # Resize partition table
          sudo parted LibreELEC-base.img resizepart 2 100%

          echo "‚úÖ Image expanded"

      - name: Mount image
        run: |
          echo "üíæ Mounting LibreELEC image..."
          cd build/libreelec

          # Setup loop device
          LOOP_DEVICE=$(sudo losetup -f)
          sudo losetup -P "${LOOP_DEVICE}" LibreELEC-base.img

          # Wait for partitions
          sleep 2
          sudo partprobe "${LOOP_DEVICE}" || true

          # Detect partition naming
          if [ -e "${LOOP_DEVICE}p1" ]; then
            BOOT_PART="${LOOP_DEVICE}p1"
            STORAGE_PART="${LOOP_DEVICE}p2"
          else
            BOOT_PART="${LOOP_DEVICE}1"
            STORAGE_PART="${LOOP_DEVICE}2"
          fi

          echo "LOOP_DEVICE=${LOOP_DEVICE}" >> $GITHUB_ENV
          echo "BOOT_PART=${BOOT_PART}" >> $GITHUB_ENV
          echo "STORAGE_PART=${STORAGE_PART}" >> $GITHUB_ENV

          # Resize filesystem
          sudo e2fsck -f -y "${STORAGE_PART}" || true
          sudo resize2fs "${STORAGE_PART}"

          # Mount partitions
          mkdir -p boot storage
          sudo mount "${BOOT_PART}" boot
          sudo mount "${STORAGE_PART}" storage

          echo "‚úÖ Image mounted"
          df -h boot storage

      - name: Build Kodi addon
        run: |
          echo "üì¶ Building Kodi addon..."

          VERSION="${{ steps.config.outputs.version }}"
          BUILD_DIR="build/addon-build"
          mkdir -p "${BUILD_DIR}/script.hdmi.tester"

          # Copy addon files
          cp -r kodi-addon/script.hdmi.tester/* "${BUILD_DIR}/script.hdmi.tester/"

          # Generate pixel test images
          mkdir -p "${BUILD_DIR}/script.hdmi.tester/resources/media/images"
          python3 kodi-addon/script.hdmi.tester/generate_pixel_images.py
          mv *.png "${BUILD_DIR}/script.hdmi.tester/resources/media/images/"

          # Copy MKV video files
          mkdir -p "${BUILD_DIR}/script.hdmi.tester/resources/media/videos"
          if [ -f "assets/image-test.mkv" ]; then
            cp "assets/image-test.mkv" "${BUILD_DIR}/script.hdmi.tester/resources/media/videos/"
            echo "‚úÖ Copied image-test.mkv"
          else
            echo "‚ö†Ô∏è  Warning: assets/image-test.mkv not found"
          fi

          if [ -f "assets/color-test.mkv" ]; then
            cp "assets/color-test.mkv" "${BUILD_DIR}/script.hdmi.tester/resources/media/videos/"
            echo "‚úÖ Copied color-test.mkv"
          else
            echo "‚ö†Ô∏è  Warning: assets/color-test.mkv not found"
          fi

          # Copy audio files
          mkdir -p "${BUILD_DIR}/script.hdmi.tester/resources/media/audio"
          if [ -f "assets/stereo.flac" ]; then
            cp "assets/stereo.flac" "${BUILD_DIR}/script.hdmi.tester/resources/media/audio/"
            echo "‚úÖ Copied stereo.flac"
          fi

          if [ -f "assets/surround51.flac" ]; then
            cp "assets/surround51.flac" "${BUILD_DIR}/script.hdmi.tester/resources/media/audio/"
            echo "‚úÖ Copied surround51.flac"
          fi

          echo "‚úÖ Addon built"

      - name: Install addon to image
        run: |
          echo "üì• Installing addon to LibreELEC image..."
          cd build/libreelec

          # Create Kodi addons directory
          sudo mkdir -p storage/.kodi/addons

          # Copy addon
          sudo cp -r ../addon-build/script.hdmi.tester storage/.kodi/addons/

          # Set proper ownership (LibreELEC uses UID/GID 1000)
          sudo chown -R 1000:1000 storage/.kodi

          echo "‚úÖ Addon installed"

      - name: Apply LibreELEC configuration
        run: |
          echo "‚öôÔ∏è  Applying LibreELEC configuration..."
          cd build/libreelec

          # Copy boot config
          sudo cp ../../libreelec-config/config.txt boot/

          # Create .config directory for storage partition
          sudo mkdir -p storage/.config

          # Copy autostart script
          sudo cp ../../libreelec-config/autostart.sh storage/.config/
          sudo chmod +x storage/.config/autostart.sh

          # Copy Kodi settings
          sudo mkdir -p storage/.kodi/userdata
          sudo cp ../../libreelec-config/advancedsettings.xml storage/.kodi/userdata/
          sudo mkdir -p storage/.kodi/userdata/keymaps
          sudo cp ../../libreelec-config/hdmi-tester.xml storage/.kodi/userdata/keymaps/

          # Enable addon and configure auto-start
          sudo mkdir -p storage/.kodi/userdata/addon_data/script.hdmi.tester
          sudo bash -c 'printf "%s\n" "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\"?>" "<settings version=\"2\">" "    <setting id=\"auto_start_test\">hdmi_test</setting>" "    <setting id=\"debug_mode\">false</setting>" "    <setting id=\"test_duration\">30</setting>" "</settings>" > storage/.kodi/userdata/addon_data/script.hdmi.tester/settings.xml'

          sudo chown -R 1000:1000 storage/.kodi storage/.config

          echo "‚úÖ Configuration applied"

      - name: Unmount and finalize image
        if: always()
        run: |
          echo "üíæ Finalizing image..."
          cd build/libreelec

          # Sync and unmount
          sudo sync
          sudo umount boot storage || true
          sudo losetup -d "${LOOP_DEVICE}" || true

          # Rename to final name
          VERSION="${{ steps.config.outputs.version }}"
          mv LibreELEC-base.img "LibreELEC-HDMI-Tester-v${VERSION}.img"

          echo "‚úÖ Image finalized"

      - name: Compress image
        id: compress
        run: |
          echo "üóúÔ∏è  Compressing image..."
          cd build/libreelec

          VERSION="${{ steps.config.outputs.version }}"
          pigz -9 "LibreELEC-HDMI-Tester-v${VERSION}.img"

          IMAGE_SIZE=$(ls -lh "LibreELEC-HDMI-Tester-v${VERSION}.img.gz" | awk '{print $5}')
          echo "image_size=${IMAGE_SIZE}" >> $GITHUB_OUTPUT
          echo "image_path=build/libreelec/LibreELEC-HDMI-Tester-v${VERSION}.img.gz" >> $GITHUB_OUTPUT

          echo "‚úÖ Image compressed: ${IMAGE_SIZE}"

      - name: Generate checksums
        run: |
          cd build/libreelec
          VERSION="${{ steps.config.outputs.version }}"
          sha256sum "LibreELEC-HDMI-Tester-v${VERSION}.img.gz" > "LibreELEC-HDMI-Tester-v${VERSION}.img.gz.sha256"
          cat "LibreELEC-HDMI-Tester-v${VERSION}.img.gz.sha256"

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.config.outputs.tag }}
          name: "LibreELEC HDMI Tester v${{ steps.config.outputs.version }}"
          body: |
            # LibreELEC HDMI Tester v${{ steps.config.outputs.version }}

            Complete LibreELEC image with HDMI Tester addon pre-installed and configured.

            ## Installation
            1. Download `LibreELEC-HDMI-Tester-v${{ steps.config.outputs.version }}.img.gz`
            2. Flash to SD card using Raspberry Pi Imager or balenaEtcher
            3. Insert SD card into Raspberry Pi 4 or 5
            4. Connect HDMI and power on
            5. HDMI test will start automatically on boot

            ## Features
            - LibreELEC 12.x (Kodi 21 "Omega")
            - HDMI Tester addon pre-installed
            - Auto-start configured
            - All test media included
            - Keyboard shortcuts enabled (Ctrl+T to launch)

            **Size:** ${{ steps.compress.outputs.image_size }}
          files: |
            build/libreelec/LibreELEC-HDMI-Tester-v${{ steps.config.outputs.version }}.img.gz
            build/libreelec/*.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
