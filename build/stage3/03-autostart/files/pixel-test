#!/bin/bash
# Pixel Test: Loop the color test pattern video (fullscreen stretched)

# Source configuration library
source /usr/local/lib/hdmi-tester/config-lib.sh

LOG_DIR="/logs"
LOG_FILE="${LOG_DIR}/pixel-test.log"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Log rotation: keep only 10 most recent logs and cap size
rotate_logs() {
    local base_log="$1"
    local max_logs=10

    if [ -f "${base_log}" ]; then
        local size
        size=$(stat -f%z "${base_log}" 2>/dev/null || stat -c%s "${base_log}" 2>/dev/null || echo 0)
        if [ "${size}" -gt 5242880 ]; then
            local timestamp
            timestamp=$(date '+%Y%m%d_%H%M%S')
            mv "${base_log}" "${base_log}.${timestamp}"
        fi
    fi

    ls -t "${base_log}".* 2>/dev/null | tail -n +$((max_logs + 1)) | xargs -r rm -f
}

rotate_logs "${LOG_FILE}"

# Setup unbuffered logging (persist even if the script is terminated)
exec > >(tee -a "${LOG_FILE}") 2>&1

VLC_PID=""

# Trap handler to clean up VLC on exit or interruption
cleanup() {
    local exit_code="$1"
    echo "=== Script terminated at $(date '+%Y-%m-%d %H:%M:%S') (exit code: ${exit_code}) ==="
    if [ -n "${VLC_PID}" ] && kill -0 "${VLC_PID}" 2>/dev/null; then
        kill -TERM "${VLC_PID}" 2>/dev/null || true
    fi
    sync
}
trap 'cleanup "$?"' EXIT INT TERM

# Cache debug flag once
if is_debug_enabled; then
    DEBUG_ENABLED=true
else
    DEBUG_ENABLED=false
fi

# Detect Raspberry Pi model and choose appropriate video format
detect_video_format() {
    local model_info
    model_info=$(grep 'Model' /proc/cpuinfo | head -1)

    if echo "${model_info}" | grep -qE 'Raspberry Pi [45678]'; then
        echo "webm"
    else
        echo "mp4"
    fi
}

VIDEO_FORMAT=$(detect_video_format)
VIDEO_FILE="/opt/hdmi-tester/color-test.${VIDEO_FORMAT}"

echo "==========================================="
echo "Pixel Test Loop (VLC) - Started $(date '+%Y-%m-%d %H:%M:%S')"
echo "==========================================="
echo "Video Format: ${VIDEO_FORMAT} (auto-detected)"
echo "File: ${VIDEO_FILE}"
echo "Log: ${LOG_FILE}"
echo "PID: $$"
echo "User: $(whoami)"
echo "Working Directory: $(pwd)"
echo ""

echo "=== Video File Check ==="
if [ ! -f "${VIDEO_FILE}" ]; then
    echo "❌ ERROR: Video file not found at ${VIDEO_FILE}"
    exit 1
fi

if [ "${DEBUG_ENABLED}" = true ]; then
    echo "  Path: ${VIDEO_FILE}"
    echo "  Size: $(ls -lh "${VIDEO_FILE}" | awk '{print $5}')"
    echo "  MD5: $(md5sum "${VIDEO_FILE}" | cut -d' ' -f1)"
    echo "  Details:"
    file "${VIDEO_FILE}"
    echo ""
else
    echo "✓ Video asset verified"
    echo ""
fi

if [ "${DEBUG_ENABLED}" = true ]; then
    echo "=== System Information ==="
    echo "Hostname: $(hostname)"
    echo "Kernel: $(uname -r)"
    echo "OS: $(grep PRETTY_NAME /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '"')"
    echo "Architecture: $(uname -m)"
    echo "CPU: $(grep 'Model' /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)"
    echo "CPU Cores: $(nproc)"
    echo "Memory Total: $(free -h | awk '/^Mem:/ {print $2}')"
    echo "Memory Available: $(free -h | awk '/^Mem:/ {print $7}')"
    echo "GPU Memory: $(vcgencmd get_mem gpu 2>/dev/null || echo 'N/A')"
    echo "CPU Temperature: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
    echo "CPU Frequency: $(vcgencmd measure_clock arm 2>/dev/null || echo 'N/A')"
    echo "Uptime: $(uptime -p)"
    echo ""

    echo "=== Boot Configuration ==="
    if [ -f /boot/firmware/config.txt ]; then
        echo "HDMI Config:"
        grep -E '^hdmi_|^gpu_mem' /boot/firmware/config.txt 2>/dev/null || echo "No HDMI config found"
    elif [ -f /boot/config.txt ]; then
        echo "HDMI Config:"
        grep -E '^hdmi_|^gpu_mem' /boot/config.txt 2>/dev/null || echo "No HDMI config found"
    fi
    echo ""

    echo "=== Display Information ==="
    echo "Connected Displays:"
    for display in /sys/class/drm/card*/status; do
        if [ -f "${display}" ]; then
            local_name=$(echo "${display}" | cut -d/ -f5)
            status=$(cat "${display}")
            echo "  ${local_name}: ${status}"
        fi
    done
    echo ""
    echo "HDMI Status:"
    tvservice -s 2>/dev/null || echo "tvservice not available"
    echo ""

    echo "=== DRM Devices ==="
    if [ -d /dev/dri/ ]; then
        ls -lah /dev/dri/ 2>&1
        echo ""
        echo "DRM Device Ownership:"
        stat -c '%A %U:%G %n' /dev/dri/* 2>&1
    else
        echo "No /dev/dri/ found"
    fi
    echo ""

    echo "=== Audio Devices ==="
    echo "ALSA Devices:"
    aplay -l 2>&1 || echo "No ALSA devices found"
    echo ""
    echo "Audio Sinks:"
    pactl list sinks short 2>&1 || echo "PulseAudio not available"
    echo ""

    echo "=== Environment Variables ==="
    echo "DISPLAY=${DISPLAY:-not set}"
    echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-not set}"
    echo "TERM=${TERM:-not set}"
    echo "PATH=${PATH}"
    echo ""

    echo "=== VLC Version and Capabilities ==="
    cvlc --version 2>&1
    echo ""
    echo "VLC Video Outputs:"
    cvlc --list | grep -A 50 'vout' 2>&1 | head -60
    echo ""
    echo "VLC Audio Outputs:"
    cvlc --list | grep -A 50 'aout' 2>&1 | head -60
    echo ""
    echo "VLC Modules:"
    cvlc --list 2>&1 | head -100
    echo ""

    echo "=== System Resources (Before Start) ==="
    echo "Load Average: $(cat /proc/loadavg)"
    echo "Memory:"
    free -h
    echo ""
    echo "Disk Space:"
    df -h / /boot 2>/dev/null
    echo ""

    echo "=== Process Information ==="
    echo "Running video processes:"
    ps aux | grep -E 'vlc|ffmpeg' | grep -v grep || echo "None"
    echo ""
else
    echo "Pixel Test: HDMI color pattern playback (debug disabled)"
    echo "Verbose diagnostics are available when DEBUG_MODE=true"
    echo ""
fi

# Get debug flags from configuration
VLC_FLAGS=$(get_vlc_flags)

if [ "${DEBUG_ENABLED}" = true ]; then
    echo "=== Starting VLC (Verbose Mode) ==="
    echo "Video Output: auto-detect (VLC will choose best available)"
    echo "Command: cvlc --loop --fullscreen --no-autoscale --no-video-title-show --no-osd --aout=alsa --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} ${VIDEO_FILE}"
    echo "Start Time: $(date '+%Y-%m-%d %H:%M:%S.%N')"
    echo ""
    echo "--- VLC Output Below ---"
    echo ""
else
    echo "Starting pixel test loop at $(date '+%Y-%m-%d %H:%M:%S')"
    echo ""
fi

# Run VLC in the background to allow trap-based cleanup
cvlc --loop --fullscreen --no-autoscale --no-video-title-show --no-osd \
    --aout=alsa \
    --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
    "${VIDEO_FILE}" 2>&1 &

VLC_PID=$!

# Wait for VLC to finish (normally runs indefinitely)
wait ${VLC_PID}
EXIT_CODE=$?
VLC_PID=""

if [ "${DEBUG_ENABLED}" = true ]; then
    echo "VLC exited with code ${EXIT_CODE}"
elif [ ${EXIT_CODE} -ne 0 ]; then
    echo "⚠️  VLC exited unexpectedly with code ${EXIT_CODE}"
fi
