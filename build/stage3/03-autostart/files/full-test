#!/bin/bash
# Full Test: Combined image-test + color-test videos

# Source configuration library
source /usr/local/lib/hdmi-tester/config-lib.sh

LOG_DIR="/logs"
LOG_FILE="${LOG_DIR}/full-test.log"

# Ensure log directory exists
mkdir -p "${LOG_DIR}"

# Log rotation: keep only 10 most recent logs and cap size to 5MB
rotate_logs() {
    local base_log="$1"
    local max_logs=10

    if [ -f "${base_log}" ]; then
        local size
        size=$(stat -f%z "${base_log}" 2>/dev/null || stat -c%s "${base_log}" 2>/dev/null || echo 0)
        if [ "${size}" -gt 5242880 ]; then
            local timestamp
            timestamp=$(date '+%Y%m%d_%H%M%S')
            mv "${base_log}" "${base_log}.${timestamp}"
        fi
    fi

    ls -t "${base_log}".* 2>/dev/null | tail -n +$((max_logs + 1)) | xargs -r rm -f
}

rotate_logs "${LOG_FILE}"

# Setup unbuffered logging (survives crashes)
exec > >(tee -a "${LOG_FILE}") 2>&1

# Trap handler to ensure logs are flushed on exit/error
cleanup() {
    local exit_code="$1"
    echo "=== Script terminated at $(date '+%Y-%m-%d %H:%M:%S') (exit code: ${exit_code}) ==="
    sync  # Flush filesystem buffers
}
trap 'cleanup "$?"' EXIT INT TERM

# Cache debug flag to control verbosity
if is_debug_enabled; then
    DEBUG_ENABLED=true
else
    DEBUG_ENABLED=false
fi

# Detect Raspberry Pi model and choose appropriate video format
# Pi 4 and higher: Use WebM (VP9 with hardware support)
# Pi 3 and lower: Use H.264 (hardware accelerated)
detect_video_format() {
    local model_info
    model_info=$(cat /proc/cpuinfo | grep "Model" | head -1)

    # Extract Pi version (look for "Raspberry Pi 4" or "Raspberry Pi 5", etc.)
    if echo "${model_info}" | grep -qE "Raspberry Pi [45678]"; then
        echo "webm"  # Pi 4+ has VP9 support
    else
        echo "mp4"   # Pi 3 and earlier: use H.264
    fi
}

VIDEO_FORMAT=$(detect_video_format)
IMAGE_VIDEO="/opt/hdmi-tester/image-test.${VIDEO_FORMAT}"
COLOR_VIDEO="/opt/hdmi-tester/color-test.${VIDEO_FORMAT}"
STEREO_FILE="/opt/hdmi-tester/stereo.flac"
SURROUND_FILE="/opt/hdmi-tester/surround51.flac"

# Use VLC auto-detect for video output
# VLC will automatically select the best available output

print_asset_status() {
    local label="$1"
    local path="$2"
    local type="$3"

    if [ ! -f "${path}" ]; then
        echo "❌ ERROR: ${label} not found at ${path}"
        exit 1
    fi

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "✓ ${label}"
        echo "  Path: ${path}"
        echo "  Size: $(ls -lh "${path}" | awk '{print $5}')"
        echo "  MD5: $(md5sum "${path}" | cut -d' ' -f1)"
        if [ "${type}" = "video" ] && command -v ffprobe >/dev/null 2>&1; then
            echo "  Metadata:"
            ffprobe -v quiet -show_format -show_streams "${path}" 2>&1 | head -40 | sed 's/^/    /'
        elif [ "${type}" = "audio" ] && command -v ffprobe >/dev/null 2>&1; then
            echo "  Metadata:"
            ffprobe -v quiet -show_format -show_streams "${path}" 2>&1 | head -30 | sed 's/^/    /'
        fi
        echo ""
    else
        echo "✓ ${label}"
    fi
}

run_cvlc() {
    local description="$1"
    shift

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "[${LOOP_COUNT}] ${description}"
        echo "Start: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo "Command: cvlc $*"
    else
        echo "[${LOOP_COUNT}] ${description}"
    fi

    cvlc "$@" 2>&1
    local exit_code=$?

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "Exit code: ${exit_code}"
        echo "End: $(date '+%Y-%m-%d %H:%M:%S.%N')"
        echo ""
    elif [ ${exit_code} -ne 0 ]; then
        echo "⚠️  ${description} exited with code ${exit_code}"
        echo ""
    fi
}

# Log startup info
echo "==========================================="
echo "Combined Test Loop (VLC) - Started $(date '+%Y-%m-%d %H:%M:%S')"
echo "==========================================="
echo "Video Format: ${VIDEO_FORMAT} (auto-detected)"
echo "Video Output: auto-detect (VLC will choose best available)"
echo "Files:"
echo "  - ${IMAGE_VIDEO}"
echo "  - ${COLOR_VIDEO}"
echo "  - ${STEREO_FILE}"
echo "  - ${SURROUND_FILE}"
echo "Log: ${LOG_FILE}"
echo "PID: $$"
echo "User: $(whoami)"
echo "Working Directory: $(pwd)"
echo "Debug Mode: ${DEBUG_ENABLED}"
echo ""
echo "Sequence: image ➜ color ➜ stereo ➜ surround (loop)"
echo "Press Ctrl+C to stop"
echo ""

if [ "${DEBUG_ENABLED}" = true ]; then
    echo "=== System Information ==="
    echo "Hostname: $(hostname)"
    echo "Kernel: $(uname -r)"
    echo "OS: $(grep PRETTY_NAME /etc/os-release 2>/dev/null | cut -d= -f2 | tr -d '"')"
    echo "Architecture: $(uname -m)"
    echo "CPU: $(grep 'Model' /proc/cpuinfo | head -1 | cut -d: -f2 | xargs)"
    echo "CPU Cores: $(nproc)"
    echo "Memory Total: $(free -h | awk '/^Mem:/ {print $2}')"
    echo "Memory Available: $(free -h | awk '/^Mem:/ {print $7}')"
    echo "GPU Memory: $(vcgencmd get_mem gpu 2>/dev/null || echo 'N/A')"
    echo "CPU Temperature: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
    echo ""

    echo "=== Display Information ==="
    tvservice -s 2>/dev/null || echo "tvservice not available"
    echo ""

    echo "=== Audio Devices ==="
    aplay -l 2>&1 | head -10 || echo "No ALSA devices"
    echo ""

    echo "=== VLC Version ==="
    cvlc --version 2>&1 | head -5
    echo ""
else
    echo "Debug mode disabled: suppressing verbose diagnostics"
    echo ""
fi

echo "=== Video Asset Validation ==="
print_asset_status "Image test video" "${IMAGE_VIDEO}" "video"
print_asset_status "Color test video" "${COLOR_VIDEO}" "video"

echo "=== Audio Asset Validation ==="
print_asset_status "Stereo FLAC" "${STEREO_FILE}" "audio"
print_asset_status "5.1 Surround FLAC" "${SURROUND_FILE}" "audio"

# Loop counter
LOOP_COUNT=0

# VLC will auto-detect best video output
VIDEO_FLAGS=""

# Get debug flags from config
VLC_FLAGS=$(get_vlc_flags)

while true; do
    LOOP_COUNT=$((LOOP_COUNT + 1))

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "==========================================="
        echo "Loop Iteration: ${LOOP_COUNT}"
        echo "Time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "CPU Temp: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
        echo "Load: $(cut -d' ' -f1-3 /proc/loadavg)"
        echo "Memory Free: $(free -h | awk '/^Mem:/ {print $7}')"
        echo "==========================================="
        echo ""
    else
        echo "--- Loop ${LOOP_COUNT} @ $(date '+%H:%M:%S') ---"
    fi

    run_cvlc "Image test (${VIDEO_FORMAT})" \
        --play-and-exit --no-video-title-show \
        ${VIDEO_FLAGS} --aout=alsa \
        --audio-resampler=soxr --audio-filter=normvol \
        --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
        "${IMAGE_VIDEO}"

    run_cvlc "Color test (${VIDEO_FORMAT})" \
        --play-and-exit --fullscreen --no-autoscale \
        --no-video-title-show \
        ${VIDEO_FLAGS} --aout=alsa \
        --audio-resampler=soxr --audio-filter=normvol \
        --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
        "${COLOR_VIDEO}"

    run_cvlc "Stereo FLAC" \
        --play-and-exit --no-video --aout=alsa \
        --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
        "${STEREO_FILE}"

    run_cvlc "5.1 Surround FLAC" \
        --play-and-exit --no-video --aout=alsa \
        --no-audio-time-stretch --audio-replay-gain-mode=none ${VLC_FLAGS} \
        "${SURROUND_FILE}"

    if [ "${DEBUG_ENABLED}" = true ]; then
        echo "Restarting loop (iteration ${LOOP_COUNT} complete)"
        echo ""
    fi

    sleep 1
done
