#!/bin/bash
# HDMI Audio Playback Script
# Plays audio test file in loop with comprehensive debugging

set -e

AUDIO_FILE="/opt/hdmi-tester/audio.mp3"

echo "========================================="
echo "HDMI Audio Playback Test"
echo "========================================="
echo "Timestamp: $(date)"
echo ""

# System info
echo "üñ•Ô∏è  System Information:"
echo "   User: $(whoami)"
echo "   Groups: $(groups)"
echo ""

# Check if audio file exists
echo "üìÅ Checking audio test file..."
if [ ! -f "${AUDIO_FILE}" ]; then
    echo "‚ùå ERROR: Audio file not found at ${AUDIO_FILE}"
    exit 1
fi
echo "‚úì Audio file exists: $(stat -c%s ${AUDIO_FILE}) bytes"
file "${AUDIO_FILE}"
echo ""

# Check mpv command
echo "üîß Checking mpv command..."
if ! command -v mpv >/dev/null 2>&1; then
    echo "‚ùå ERROR: mpv command not found"
    echo "   Install with: sudo apt-get install mpv"
    exit 1
fi
echo "‚úì mpv found at: $(which mpv)"
mpv --version | head -1
echo ""

# Detect ALSA devices
echo "üîä Detecting ALSA audio devices..."
echo ""
echo "--- Available playback devices (aplay -l) ---"
if aplay -l 2>&1; then
    APLAY_SUCCESS=true
else
    echo "‚ö†Ô∏è  WARNING: aplay -l failed"
    APLAY_SUCCESS=false
fi
echo ""

echo "--- ALSA sound cards (/proc/asound/cards) ---"
if [ -f /proc/asound/cards ]; then
    cat /proc/asound/cards
else
    echo "‚ö†Ô∏è  WARNING: /proc/asound/cards not found"
fi
echo ""

echo "--- ALSA PCM devices (first 30 lines) ---"
aplay -L 2>&1 | head -30 || echo "‚ö†Ô∏è  WARNING: Could not list ALSA devices"
echo ""

# Check for HDMI audio specifically
echo "üéØ Checking for HDMI audio..."
HDMI_FOUND=false
if aplay -l 2>&1 | grep -i hdmi >/dev/null; then
    echo "‚úì HDMI audio device detected:"
    aplay -l 2>&1 | grep -i hdmi
    HDMI_FOUND=true
else
    echo "‚ö†Ô∏è  WARNING: No HDMI audio device found in aplay -l"
    echo "   Will attempt playback anyway..."
fi
echo ""

# Determine audio device to use
echo "üéµ Determining audio device..."
AUDIO_DEVICE=""

# Try to find the best HDMI device
if [ "$HDMI_FOUND" = true ]; then
    # Check for common HDMI device names
    if aplay -L 2>&1 | grep -q "hdmi:CARD=vc4hdmi"; then
        AUDIO_DEVICE="alsa/hdmi:CARD=vc4hdmi,DEV=0"
        echo "   Selected device: ${AUDIO_DEVICE} (vc4hdmi)"
    elif aplay -L 2>&1 | grep -q "hdmi:CARD=b1"; then
        AUDIO_DEVICE="alsa/hdmi:CARD=b1,DEV=0"
        echo "   Selected device: ${AUDIO_DEVICE} (b1)"
    else
        AUDIO_DEVICE="auto"
        echo "   Selected device: auto (HDMI detected but using auto-detection)"
    fi
else
    AUDIO_DEVICE="auto"
    echo "   Selected device: auto (no HDMI detected, will try all devices)"
fi
echo ""

# List available mpv audio devices
echo "üîç MPV audio output devices:"
mpv --audio-device=help 2>&1 | head -20 || echo "‚ö†Ô∏è  Could not list mpv devices"
echo ""

# Launch mpv with selected device
echo "üöÄ Launching audio playback..."
echo "   Audio file: ${AUDIO_FILE}"
echo "   Device: ${AUDIO_DEVICE}"
echo "   Mode: Infinite loop"
echo "   Volume: 100%"
echo "   Press Ctrl+C to stop"
echo ""
echo "========================================="
echo ""

# Try primary device first, then fallback
if [ "${AUDIO_DEVICE}" = "auto" ]; then
    echo "‚ñ∂Ô∏è  Attempting playback with auto device selection..."
    exec mpv --loop=inf --no-video --audio-device=auto --volume=100 "${AUDIO_FILE}"
else
    echo "‚ñ∂Ô∏è  Attempting playback with ${AUDIO_DEVICE}..."
    echo "   (If this fails, will retry with auto device selection)"
    echo ""

    # Try specific device, fallback to auto on failure
    if ! mpv --loop=inf --no-video --audio-device="${AUDIO_DEVICE}" --volume=100 "${AUDIO_FILE}" 2>&1; then
        echo ""
        echo "‚ö†Ô∏è  Primary device failed, retrying with auto selection..."
        echo ""
        exec mpv --loop=inf --no-video --audio-device=auto --volume=100 "${AUDIO_FILE}"
    fi
fi
