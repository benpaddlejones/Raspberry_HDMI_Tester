#!/bin/bash
# Test Script: Display static image with audio using VLC
# Plays image.png fullscreen while looping audio.mp3

IMAGE_FILE="/opt/hdmi-tester/image.png"
AUDIO_FILE="/opt/hdmi-tester/audio.mp3"
LOG_FILE="/tmp/test-notvideo.log"

#!/bin/bash
#!/bin/bash
# Static Image + Audio Loop Test
# Displays static image with FLAC audio (stereo then surround) using VLC

# NOTE: Override conflicts with main hdmi-test script
# Both try to start VLC at the same time. Disabled by default.
LOG_FILE="/tmp/test-notvideo.log"

# Log rotation: Keep only 10 most recent logs
rotate_logs() {
    local base_log="$1"
    local max_logs=10

    # If current log exists and is larger than 5MB, rotate it
    if [ -f "${base_log}" ]; then
        local size
        size=$(stat -f%z "${base_log}" 2>/dev/null || stat -c%s "${base_log}" 2>/dev/null || echo 0)
        if [ "${size}" -gt 5242880 ]; then  # 5MB
            local timestamp
            timestamp=$(date '+%Y%m%d_%H%M%S')
            mv "${base_log}" "${base_log}.${timestamp}"
        fi
    fi

    # Remove old rotated logs, keep only most recent 10
    ls -t "${base_log}".* 2>/dev/null | tail -n +$((max_logs + 1)) | xargs -r rm -f
}

rotate_logs "${LOG_FILE}"

# Setup unbuffered logging (survives crashes)
exec > >(tee -a "${LOG_FILE}") 2>&1

# Trap handler to ensure logs are flushed on exit/error
cleanup() {
    echo "=== Script terminated at $(date '+%Y-%m-%d %H:%M:%S') (exit code: $?) ==="
    sync  # Flush filesystem buffers
}
trap cleanup EXIT INT TERM

# Detect Raspberry Pi model and choose appropriate video output
detect_vout_method() {
    local model_info
    model_info=$(cat /proc/cpuinfo | grep "Model" | head -1)

    # Extract Pi version (look for "Raspberry Pi 4" or "Raspberry Pi 5", etc.)
    if echo "${model_info}" | grep -qE "Raspberry Pi [45678]"; then
        echo "drm"  # Pi 4+ use DRM
    else
        echo "fbdev"   # Pi 3 and earlier: use framebuffer
    fi
}

VOUT_METHOD=$(detect_vout_method)

# Set video output flags based on method
if [ "${VOUT_METHOD}" = "drm" ]; then
    VOUT_FLAGS="--vout=drm --drm-vout-no-modeset"
else
    VOUT_FLAGS="--vout=fbdev --fbdev=/dev/fb0"
fi

# System information
echo "=== System Information ==="
echo "Hostname: $(hostname)"
    echo "Kernel: $(uname -r)"
    echo "OS: $(cat /etc/os-release 2>/dev/null | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')"
    echo "Architecture: $(uname -m)"
    echo "CPU: $(cat /proc/cpuinfo | grep "Model" | head -1 | cut -d: -f2 | xargs)"
    echo "CPU Cores: $(nproc)"
    echo "Memory Total: $(free -h | awk '/^Mem:/ {print $2}')"
    echo "Memory Available: $(free -h | awk '/^Mem:/ {print $7}')"
    echo "GPU Memory: $(vcgencmd get_mem gpu 2>/dev/null || echo 'N/A')"
    echo "CPU Temperature: $(vcgencmd measure_temp 2>/dev/null || echo 'N/A')"
    echo "CPU Frequency: $(vcgencmd measure_clock arm 2>/dev/null || echo 'N/A')"
    echo "Uptime: $(uptime -p)"
    echo ""

    # Boot configuration
    echo "=== Boot Configuration ==="
    if [ -f /boot/firmware/config.txt ]; then
        echo "HDMI Config:"
        grep -E "^hdmi_|^gpu_mem" /boot/firmware/config.txt 2>/dev/null || echo "No HDMI config found"
    elif [ -f /boot/config.txt ]; then
        echo "HDMI Config:"
        grep -E "^hdmi_|^gpu_mem" /boot/config.txt 2>/dev/null || echo "No HDMI config found"
    fi
    echo ""

    # Display information
    echo "=== Display Information ==="
    echo "Connected Displays:"
    for display in /sys/class/drm/card*/status; do
        if [ -f "$display" ]; then
            card=$(echo "$display" | cut -d/ -f5)
            status=$(cat "$display")
            echo "  $card: $status"
        fi
    done
    echo ""
    echo "HDMI Status:"
    tvservice -s 2>/dev/null || echo "tvservice not available"
    echo ""

    # Check DRM devices
    echo "=== DRM Devices ==="
    if [ -d /dev/dri/ ]; then
        ls -lah /dev/dri/ 2>&1
        echo ""
        echo "DRM Device Ownership:"
        stat -c "%A %U:%G %n" /dev/dri/* 2>&1
    else
        echo "No /dev/dri/ found"
    fi
    echo ""

    # Audio devices
    echo "=== Audio Devices ==="
    echo "ALSA Devices:"
    aplay -l 2>&1 || echo "No ALSA devices found"
    echo ""
    echo "Audio Sinks:"
    pactl list sinks short 2>&1 || echo "PulseAudio not available"
    echo ""

    # Check image file
    echo "=== Image File Check ==="
    if [ ! -f "${IMAGE_FILE}" ]; then
        echo "❌ ERROR: Image file not found at ${IMAGE_FILE}"
        exit 1
    fi

    ls -lh "${IMAGE_FILE}"
    echo ""
    echo "File Details:"
    file "${IMAGE_FILE}"
    echo ""
    echo "File Stats:"
    stat "${IMAGE_FILE}"
    echo ""
    echo "MD5 Checksum: $(md5sum "${IMAGE_FILE}" | cut -d' ' -f1)"
    echo ""

    # Check audio file
    echo "=== Audio File Check ==="
    if [ ! -f "${AUDIO_FILE}" ]; then
        echo "❌ ERROR: Audio file not found at ${AUDIO_FILE}"
        exit 1
    fi

    ls -lh "${AUDIO_FILE}"
    echo ""
    echo "File Details:"
    file "${AUDIO_FILE}"
    echo ""
    echo "File Stats:"
    stat "${AUDIO_FILE}"
    echo ""
    echo "MD5 Checksum: $(md5sum "${AUDIO_FILE}" | cut -d' ' -f1)"
    echo ""

    # Audio metadata
    echo "Audio Metadata (ffprobe):"
    if command -v ffprobe &> /dev/null; then
        ffprobe -v quiet -show_format -show_streams "${AUDIO_FILE}" 2>&1 | head -50
    else
        echo "ffprobe not available"
    fi
    echo ""

    # Environment variables
    echo "=== Environment Variables ==="
    echo "DISPLAY=${DISPLAY:-not set}"
    echo "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-not set}"
    echo "TERM=${TERM:-not set}"
    echo "PATH=${PATH}"
    echo ""

    # Check VLC version and capabilities
    echo "=== VLC Version and Capabilities ==="
    cvlc --version 2>&1
    echo ""
    echo "VLC Video Outputs:"
    cvlc --list | grep -A 50 "vout" 2>&1 | head -60
    echo ""
    echo "VLC Audio Outputs:"
    cvlc --list | grep -A 50 "aout" 2>&1 | head -60
    echo ""

    # System resources before start
    echo "=== System Resources (Before Start) ==="
    echo "Load Average: $(cat /proc/loadavg)"
    echo "Memory:"
    free -h
    echo ""
    echo "Disk Space:"
    df -h / /boot 2>/dev/null
    echo ""

    # Process information
    echo "=== Process Information ==="
    echo "Running video processes:"
    ps aux | grep -E "vlc|ffmpeg" | grep -v grep || echo "None"
    echo ""

    # Detect HDMI audio device dynamically
    echo "=== Detecting HDMI Audio Device ==="
    HDMI_DEVICE=$(/opt/hdmi-tester/detect-hdmi-audio)
    echo "Detected HDMI audio device: ${HDMI_DEVICE}"
    echo ""

    echo "=== Starting VLC (Reduced Verbosity) ==="
    echo "Command: AUDIODEV=${HDMI_DEVICE} cvlc --no-video-title-show --fullscreen --loop ${VOUT_FLAGS} --aout=alsa --no-audio-time-stretch --audio-replay-gain-mode=none -v ${IMAGE_FILE} ${AUDIO_FILE}"
    echo "Start Time: $(date '+%Y-%m-%d %H:%M:%S.%N')"
    echo ""
    echo "--- VLC Output Below ---"
    echo ""

    # Run VLC with reduced verbosity (use -v instead of -vv to reduce log size)
    # Use AUDIODEV environment variable to set ALSA device
    export AUDIODEV="${HDMI_DEVICE}"
    exec cvlc --no-video-title-show --fullscreen --loop \
        ${VOUT_FLAGS} --aout=alsa \
        --no-audio-time-stretch --audio-replay-gain-mode=none -v \
        "${IMAGE_FILE}" "${AUDIO_FILE}" 2>&1
