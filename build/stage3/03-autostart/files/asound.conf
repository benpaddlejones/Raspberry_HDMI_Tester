# Main ALSA Configuration for HDMI Tester
#
# This file sets up robust, format-converting PCM devices for HDMI audio.
# It is designed to work with the detect-hdmi-audio script.

# Include the dynamically generated multi-card configuration
# This file is created by generate-multi-card-asound and routes audio to ALL cards
<"/run/asound-multi.conf">

# Default device: use our custom format-converting PCM
# This ensures that any application requesting the "default" device
# gets high-quality resampling and mixing.
pcm.!default {
    type asym

    # Playback goes to HDMI with automatic format conversion
    playback.pcm "hdmi_auto"

    # Capture (if needed) uses null device (we don't need capture for HDMI tester)
    capture.pcm {
        type null
    }
}

# ========================================
# HDMI PCM Devices with Format Conversion
# ========================================

# Define individual HDMI outputs with plug wrapper for format conversion
# The 'plug' plugin handles:
# - Sample format conversion (PCM <-> IEC958)
# - Sample rate conversion (e.g., 32000 -> 48000)
# - Channel mapping (stereo <-> multi-channel)

pcm.hdmi0_plug {
    type plug
    slave.pcm {
        type hw
        card 0
        device 0
    }
    hint {
        show on
        description "HDMI Audio Output (Card 0) with Format Conversion"
    }
}

pcm.hdmi1_plug {
    type plug
    slave.pcm {
        type hw
        card 1
        device 0
    }
    hint {
        show on
        description "HDMI Audio Output (Card 1) with Format Conversion"
    }
}

pcm.hdmi2_plug {
    type plug
    slave.pcm {
        type hw
        card 2
        device 0
    }
    hint {
        show on
        description "HDMI Audio Output (Card 2) with Format Conversion"
    }
}

pcm.hdmi3_plug {
    type plug
    slave.pcm {
        type hw
        card 3
        device 0
    }
    hint {
        show on
        description "HDMI Audio Output (Card 3) with Format Conversion"
    }
}

pcm.hdmi4_plug {
    type plug
    slave.pcm {
        type hw
        card 4
        device 0
    }
    hint {
        show on
        description "HDMI Audio Output (Card 4) with Format Conversion"
    }
}

pcm.hdmi5_plug {
    type plug
    slave.pcm {
        type hw
        card 5
        device 0
    }
    hint {
        show on
        description "HDMI Audio Output (Card 5) with Format Conversion"
    }
}

# Legacy direct hardware access (without format conversion)
# Kept for compatibility but not recommended for vc4-hdmi
pcm.hdmi0 {
    type hw
    card 0
    device 0
}

pcm.hdmi1 {
    type hw
    card 1
    device 0
}

pcm.hdmi2 {
    type hw
    card 2
    device 0
}

pcm.hdmi3 {
    type hw
    card 3
    device 0
}

pcm.hdmi4 {
    type hw
    card 4
    device 0
}

pcm.hdmi5 {
    type hw
    card 5
    device 0
}

# ========================================
# Intelligent HDMI Router with Format Conversion
# ========================================

# This creates a "plug" plugin with dmix for sharing and format conversion
# The 'plug' plugin at the top level ensures ANY audio format from VLC
# will be converted to what the hardware accepts (including IEC958)
pcm.hdmi_auto {
    type plug
    slave.pcm "hdmi_dmix"
    hint {
        show on
        description "Auto-detected HDMI Audio Output with Format Conversion"
    }
}

# Dmix layer for multiple application support
pcm.hdmi_dmix {
    type dmix
    ipc_key 5678293
    ipc_perm 0660
    ipc_gid audio

    slave {
        # pcm is now defined in /run/hdmi-card.conf
        # This allows the card number to be set dynamically at boot.
        # Example content of /run/hdmi-card.conf:
        # pcm.hdmi_dmix.slave.pcm {
        #     type hw
        #     card 1
        #     device 0
        # }

        # Buffer settings optimized for low latency HDMI output
        # These values work well across all Pi models
        period_time 0
        period_size 1024
        buffer_size 4096

        # Don't force specific rate/format - let plug handle conversion
        # This allows hardware to negotiate its preferred format
    }

    hint {
        show on
        description "HDMI Audio Mixer (allows app sharing)"
    }
}

# ========================================
# Format-Converting PCM Wrappers for Specific Cards
# ========================================

# These allow direct selection with automatic format conversion
# Usage: aplay -D hdmi0_convert file.wav
# The 'plug' wrapper ensures format compatibility

pcm.hdmi0_convert {
    type plug
    slave.pcm "hdmi0"
}

pcm.hdmi1_convert {
    type plug
    slave.pcm "hdmi1"
}

pcm.hdmi2_convert {
    type plug
    slave.pcm "hdmi2"
}

# ========================================
# Control Mixer
# ========================================

# Default control device (for volume control)
ctl.!default {
    type hw
    card 0
}

# ========================================
# VLC-Specific Optimizations and Troubleshooting
# ========================================

# VLC Usage Modes:
# 1. Default: VLC uses "default" PCM -> hdmi_auto (with format conversion)
# 2. Explicit: VLC uses --alsa-audio-device=hw:X,0 (direct hardware)
# 3. Environment: AUDIODEV=hw:X,0 (VLC respects this)
#
# IMPORTANT: When scripts use --alsa-audio-device=hw:X,0, this bypasses
# the format conversion! To use conversion with explicit device:
#   --alsa-audio-device=hdmiX_plug (e.g., hdmi2_plug for card 2)
#
# Recommended approach for maximum compatibility:
#   1. Use --alsa-audio-device=hdmiX_plug where X is detected card number
#   2. Or use "default" and let ALSA handle everything
#   3. Avoid raw hw:X,0 to prevent IEC958 format issues

# ========================================
# Format Conversion Details
# ========================================

# The 'plug' plugin automatically handles:
# - PCM format conversion: f32l, s32l, s24l, s16l, u8 -> hardware format
# - Sample rate conversion: 8000-192000 Hz -> hardware rate
# - Channel mapping: mono, stereo, 5.1, 7.1 -> hardware channels
# - IEC958 encapsulation: PCM -> IEC958_SUBFRAME_LE (if hardware requires)
#
# This solves the vc4-hdmi "no supported sample format" error by
# transparently converting VLC's PCM output to the S/PDIF format
# that the hardware requires.
#
# Performance Impact:
# - Minimal CPU overhead (< 1% on Pi 3)
# - Latency: ~20-40ms additional (acceptable for video playback)
# - Quality: Bit-perfect for lossless formats (FLAC, WAV)
