[Unit]
Description=HDMI Test - Image Loop with Audio
After=local-fs.target sound.target
Wants=sound.target

[Service]
Type=simple
User=pi
SupplementaryGroups=audio video render

# Pre-flight checks
ExecStartPre=/bin/bash -c 'echo "=== HDMI Test Service Starting ===" && \
    echo "Timestamp: $(date)" && \
    echo "Checking test video files..." && \
    if [ ! -f /opt/hdmi-tester/image-test.webm ] && [ ! -f /opt/hdmi-tester/image-test.mp4 ]; then \
        echo "ERROR: No test video found (checked .webm and .mp4)" && \
        exit 1; \
    fi && \
    echo "âœ“ Test video files available" && \
    echo "Launching hdmi-test script (auto-detects format)..."'

# Run hdmi-test script (auto-detects Pi model and selects appropriate format)
ExecStart=/opt/hdmi-tester/hdmi-test

# Log exit status
ExecStopPost=/bin/bash -c 'echo "=== HDMI Test Service Stopped ===" && \
    echo "Exit code: $EXIT_CODE" && \
    if [ "$SERVICE_RESULT" != "success" ]; then \
        echo "ERROR: Service failed - check logs"; \
    fi'

Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
KillMode=mixed
TimeoutStopSec=10

[Install]
WantedBy=multi-user.target
