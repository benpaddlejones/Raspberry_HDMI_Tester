#!/bin/bash
# HDMI Image Display Script
# Displays test pattern on framebuffer until manually stopped

set -e

IMAGE_FILE="/opt/hdmi-tester/image.png"

echo "========================================="
echo "HDMI Image Display Test"
echo "========================================="
echo "Timestamp: $(date)"
echo ""

# Check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "âš ï¸  WARNING: Not running as root. You may need sudo for framebuffer access."
    echo "   Try: sudo hdmi-image"
    echo ""
fi

# Check if image file exists
echo "ðŸ“ Checking test pattern file..."
if [ ! -f "${IMAGE_FILE}" ]; then
    echo "âŒ ERROR: Test pattern not found at ${IMAGE_FILE}"
    exit 1
fi
echo "âœ“ Test pattern exists: $(stat -c%s ${IMAGE_FILE}) bytes"
file "${IMAGE_FILE}"
echo ""

# Check framebuffer device
echo "ðŸ–¥ï¸  Checking framebuffer device..."
if [ ! -c /dev/fb0 ]; then
    echo "âŒ ERROR: Framebuffer device /dev/fb0 not found"
    echo ""
    echo "Available devices:"
    ls -la /dev/fb* 2>&1 || echo "No framebuffer devices found"
    exit 1
fi
echo "âœ“ Framebuffer /dev/fb0 exists"
echo ""

# Check fbi command
echo "ðŸ”§ Checking fbi command..."
if ! command -v fbi >/dev/null 2>&1; then
    echo "âŒ ERROR: fbi command not found"
    echo "   Install with: sudo apt-get install fbi"
    exit 1
fi
echo "âœ“ fbi found at: $(which fbi)"
echo ""

# Display framebuffer info
echo "ðŸ“º Framebuffer information:"
fbset -s 2>&1 || echo "âš ï¸  WARNING: Could not read framebuffer settings"
echo ""

# Launch fbi
echo "ðŸš€ Launching image display..."
echo "   Image: ${IMAGE_FILE}"
echo "   Device: /dev/fb0"
echo "   Press Ctrl+C to stop"
echo ""
echo "========================================="
echo ""

# Run fbi with:
# -T 1 = Use framebuffer device 1 (fb0)
# -a = Auto-zoom to fit screen
# Redirect stderr to suppress "no exif" messages
exec fbi -T 1 -a "${IMAGE_FILE}" 2>/dev/null
